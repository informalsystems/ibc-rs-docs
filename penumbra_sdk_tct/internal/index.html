<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="The internal implementation of the tree, exposed here for documentation."><title>penumbra_sdk_tct::internal - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-b0742ba02757f159.css"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="penumbra_sdk_tct" data-themes="" data-resource-suffix="" data-rustdoc-version="1.84.0-nightly (9322d183f 2024-10-14)" data-channel="nightly" data-search-js="search-e056c65ede92db13.js" data-settings-js="settings-805db61a62df4bd2.js" ><script src="../../static.files/storage-1d39b6787ed640ff.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../static.files/main-f070b9041d14864c.js"></script><noscript><link rel="stylesheet" href="../../static.files/noscript-0111fcff984fae8f.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../penumbra_sdk_tct/index.html">penumbra_<wbr>sdk_<wbr>tct</a><span class="version">1.0.1</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Module internal</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#structure-of-implementation" title="Structure of Implementation">Structure of Implementation</a></li><li><a href="#tiers-of-nodes-of-leaves-of-items-frontier-and-complete" title="Tiers of Nodes of Leaves of Items: Frontier and Complete">Tiers of Nodes of Leaves of Items: Frontier and Complete</a></li></ul><h3><a href="#modules">Module Items</a></h3><ul class="block"><li><a href="#modules" title="Modules">Modules</a></li></ul></section><div id="rustdoc-modnav"><h2 class="in-crate"><a href="../index.html">In crate penumbra_<wbr>sdk_<wbr>tct</a></h2></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><span class="rustdoc-breadcrumbs"><a href="../index.html">penumbra_sdk_tct</a></span><h1>Module <span>internal</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../src/penumbra_sdk_tct/internal.rs.html#1-161">source</a> </span></div><span class="item-info"><div class="stab portability">Available on <strong>crate feature <code>internal</code></strong> only.</div></span><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>The internal implementation of the tree, exposed here for documentation.</p>
<p>This module and its submodules should not be expected to follow semantic versioning.</p>
<h3 id="structure-of-implementation"><a class="doc-anchor" href="#structure-of-implementation">§</a>Structure of Implementation</h3>
<p>The tiered commitment tree is not accessed directly <em>as a tree</em>; rather, the
<a href="../struct.Tree.html" title="struct penumbra_sdk_tct::Tree"><code>Tree</code></a>, <a href="../builder/epoch/struct.Builder.html" title="struct penumbra_sdk_tct::builder::epoch::Builder"><code>epoch::Builder</code></a>,
<a href="../builder/epoch/struct.Finalized.html" title="struct penumbra_sdk_tct::builder::epoch::Finalized"><code>epoch::Finalized</code></a>,
<a href="../builder/block/struct.Builder.html" title="struct penumbra_sdk_tct::builder::block::Builder"><code>block::Builder</code></a>, and
<a href="../builder/block/struct.Finalized.html" title="struct penumbra_sdk_tct::builder::block::Finalized"><code>block::Finalized</code></a> structs from the top level of the crate
contain a tree together with a hashmap which maps commitments to their corresponding index
within the tree. This <code>internal</code> module and all its submodules concern themselves solely with
the implementation of the tree itself, wherein commitments and their authentication paths are
accessed by index. The surrounding pieces of the crate make use of the internal-facing API
exposed by this module to implement an external API specific to the three-tiered
tree/epoch/block commitment tree required by Penumbra.</p>
<p>The tiered commitment tree has a very specific structure, and in this implementation we make
strong Rust’s type system to enforce that structure. In particular, we ensure that internal
nodes are non-empty, and that leaves occur only at the bottom-most level of the tree. A
consequence of this is that it is unrepresentable to build a tree which fails to be pruned of
internal nodes holding no witnessed leaves, or whose leaves are of mismatched depth. A lesser
benefit of this design is that recursive methods on trees can be monomorphized and therefore
potentially inlined to the height of tree they are called upon, avoiding ever performing runtime
checks about the tree structure (there no need to check whether a particular part of the tree is
a leaf, internal node, etc., because this is statically known).</p>
<p>This structural guarantee is achieved by defining these tree structures as <em>nested generic
types</em>, and defining their methods as <em>recursive trait implementations</em> (rather than as
inductive non-generic enumeration types with recursive methods). These traits are all defined in
<a href="interface/index.html" title="mod penumbra_sdk_tct::internal::interface"><code>interface</code></a>, but they are re-exported from <a href="frontier/index.html" title="mod penumbra_sdk_tct::internal::frontier"><code>frontier</code></a> and <a href="complete/index.html" title="mod penumbra_sdk_tct::internal::complete"><code>complete</code></a> as relevant.</p>
<h3 id="tiers-of-nodes-of-leaves-of-items-frontier-and-complete"><a class="doc-anchor" href="#tiers-of-nodes-of-leaves-of-items-frontier-and-complete">§</a>Tiers of Nodes of Leaves of Items: Frontier and Complete</h3>
<p>The primary exports of this module is the type <a href="frontier/struct.Tier.html" title="struct penumbra_sdk_tct::internal::frontier::Tier"><code>frontier::Tier</code></a>. It is in terms of this type
that the <a href="../struct.Tree.html" title="struct penumbra_sdk_tct::Tree"><code>Tree</code></a> and <a href="../builder/index.html" title="mod penumbra_sdk_tct::builder"><code>builder</code></a> structs are defined: a
<a href="../struct.Tree.html" title="struct penumbra_sdk_tct::Tree"><code>Tree</code></a> is a <code>Top&lt;Tier&lt;Tier&lt;Item&gt;&gt;&gt;</code>, an epoch is a <code>Top&lt;Tier&lt;Item&gt;&gt;</code>, and a
<code>Block</code> is a <code>Top&lt;Item&gt;</code> (each with a managed index of commitments alongside).</p>
<p>Internally, a <a href="frontier/struct.Tier.html" title="struct penumbra_sdk_tct::internal::frontier::Tier"><code>Tier</code></a> is a quadtree where every internal node is annotated with
the hash of its children, into which leaves (all at depth 8) are inserted in left to right
order. The “frontier” represents the path from the root to the rightmost leaf, at every level
containing any leftward siblings of a given frontier node, each of which is a <a href="complete/index.html" title="mod penumbra_sdk_tct::internal::complete"><code>complete</code></a> tree
which stores the finalized bulk of the items inserted into the tree. As new leaves are created,
the frontier zig-zags rightwards, pushing finalized portions of itself into the leftward
complete tree.</p>
<p>All <a href="frontier/struct.Tier.html" title="struct penumbra_sdk_tct::internal::frontier::Tier"><code>Tier</code></a>s must contain at least one child, and may be either unfinalized or
finalized; a <a href="frontier/struct.Top.html" title="struct penumbra_sdk_tct::internal::frontier::Top"><code>Top</code></a> is like a tier, but it may be empty, and may not be
finalized. Stacking a <a href="frontier/struct.Top.html" title="struct penumbra_sdk_tct::internal::frontier::Top"><code>Top</code></a> on top of <a href="frontier/struct.Tier.html" title="struct penumbra_sdk_tct::internal::frontier::Tier"><code>Tier</code></a>s allows there to
be a canonical representation for empty trees, and prevents the illegal state of a finalized
top-level tree.</p>
<p>As described above, a variety of recursively defined traits are used to define the behavior of
trees. The <a href="frontier/trait.Frontier.html" title="trait penumbra_sdk_tct::internal::frontier::Frontier"><code>Frontier</code></a> trait defines the operations possible on a frontier
of a tree, while the <a href="frontier/trait.Focus.html" title="trait penumbra_sdk_tct::internal::frontier::Focus"><code>Focus</code></a> trait defines how to operate over the tip of a
frontier, and the <a href="frontier/trait.Forget.html" title="trait penumbra_sdk_tct::internal::frontier::Forget"><code>Forget</code></a> trait defines how to remove witnessed leaves from
a frontier.</p>
<p>While the frontier changes on every inserted leaf, within the complete portion of the tree the
only changes that occur are when leaves are forgotten and their containing nodes pruned. As a
result, the traits exposed by the <a href="complete/index.html" title="mod penumbra_sdk_tct::internal::complete"><code>complete</code></a> module are merely
<a href="complete/trait.Complete.html" title="trait penumbra_sdk_tct::internal::complete::Complete"><code>Complete</code></a>, which is a marker trait used to ensure that every
<a href="frontier/trait.Frontier.html" title="trait penumbra_sdk_tct::internal::frontier::Frontier"><code>Frontier</code></a> type is paired with a unique corresponding type of complete
tree, and the <a href="complete/trait.ForgetOwned.html" title="trait penumbra_sdk_tct::internal::complete::ForgetOwned"><code>ForgetOwned</code></a> trait, which defines an equivalent to
<a href="frontier/trait.Forget.html" title="trait penumbra_sdk_tct::internal::frontier::Forget"><code>frontier::Forget</code></a> that is applicable to the by-value usage pattern of complete trees.</p>
</div></details><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="complete/index.html" title="mod penumbra_sdk_tct::internal::complete">complete</a></div><div class="desc docblock-short"><a href="complete/trait.Complete.html" title="trait penumbra_sdk_tct::internal::complete::Complete"><code>Complete</code></a> things are sparse representations of only the data that was inserted using
<a href="../enum.Witness.html#variant.Keep" title="variant penumbra_sdk_tct::Witness::Keep"><code>Witness::Keep</code></a>, with the data that was inserted using
<a href="../enum.Witness.html#variant.Forget" title="variant penumbra_sdk_tct::Witness::Forget"><code>Witness::Forget</code></a> being pruned eagerly.</div></li><li><div class="item-name"><a class="mod" href="frontier/index.html" title="mod penumbra_sdk_tct::internal::frontier">frontier</a></div><div class="desc docblock-short"><a href="frontier/trait.Frontier.html" title="trait penumbra_sdk_tct::internal::frontier::Frontier"><code>Frontier</code></a> things can be inserted into and updated, always representing the rightmost
(most recently inserted) element of a tree.</div></li><li><div class="item-name"><a class="mod" href="hash/index.html" title="mod penumbra_sdk_tct::internal::hash">hash</a></div><div class="desc docblock-short">The core <a href="hash/struct.Hash.html" title="struct penumbra_sdk_tct::internal::hash::Hash"><code>Hash</code></a> type, which is used internally to represent hashes, the
<a href="hash/trait.GetHash.html" title="trait penumbra_sdk_tct::internal::hash::GetHash"><code>GetHash</code></a> trait for computing and caching hashes of things, and the <a href="hash/struct.CachedHash.html" title="struct penumbra_sdk_tct::internal::hash::CachedHash"><code>CachedHash</code></a> type, which
is used internally for lazy evaluation of hashes.</div></li><li><div class="item-name"><a class="mod" href="height/index.html" title="mod penumbra_sdk_tct::internal::height">height</a></div><div class="desc docblock-short">Type level machinery used to statically determine the height of a tree, to ensure the correct
domain separator is used when hashing at any height.</div></li><li><div class="item-name"><a class="mod" href="interface/index.html" title="mod penumbra_sdk_tct::internal::interface">interface</a></div><div class="desc docblock-short">This module contains trait definitions for the entire interface of the internal tree. All of
them are exported from either <a href="frontier/index.html" title="mod penumbra_sdk_tct::internal::frontier"><code>frontier</code></a> or
<a href="complete/index.html" title="mod penumbra_sdk_tct::internal::complete"><code>complete</code></a>, but they are also exported from here for ease of
reading.</div></li><li><div class="item-name"><a class="mod" href="path/index.html" title="mod penumbra_sdk_tct::internal::path">path</a></div><div class="desc docblock-short">Authentication paths into the tree, generically for trees of any height.</div></li><li><div class="item-name"><a class="mod" href="proof/index.html" title="mod penumbra_sdk_tct::internal::proof">proof</a></div><div class="desc docblock-short">Transparent merkle inclusion proofs defined generically for trees of any height.</div></li><li><div class="item-name"><a class="mod" href="three/index.html" title="mod penumbra_sdk_tct::internal::three">three</a></div><div class="desc docblock-short">A wrapper around <a href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec"><code>Vec</code></a> for vectors whose length is at most 3 elements.</div></li></ul></section></div></main></body></html>