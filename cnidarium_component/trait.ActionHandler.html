<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Defines the interface for handling transaction actions."><title>ActionHandler in cnidarium_component - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-b0742ba02757f159.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="cnidarium_component" data-themes="" data-resource-suffix="" data-rustdoc-version="1.84.0-nightly (9322d183f 2024-10-14)" data-channel="nightly" data-search-js="search-e056c65ede92db13.js" data-settings-js="settings-805db61a62df4bd2.js" ><script src="../static.files/storage-1d39b6787ed640ff.js"></script><script defer src="sidebar-items.js"></script><script defer src="../static.files/main-f070b9041d14864c.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-0111fcff984fae8f.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc trait"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../cnidarium_component/index.html">cnidarium_<wbr>component</a><span class="version">1.0.1</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Action<wbr>Handler</a></h2><h3><a href="#required-associated-types">Required Associated Types</a></h3><ul class="block"><li><a href="#associatedtype.CheckStatelessContext" title="CheckStatelessContext">CheckStatelessContext</a></li></ul><h3><a href="#required-methods">Required Methods</a></h3><ul class="block"><li><a href="#tymethod.check_and_execute" title="check_and_execute">check_and_execute</a></li><li><a href="#tymethod.check_stateless" title="check_stateless">check_stateless</a></li></ul><h3><a href="#provided-methods">Provided Methods</a></h3><ul class="block"><li><a href="#method.check_historical" title="check_historical">check_historical</a></li></ul><h3><a href="#object-safety">Object Safety</a></h3><h3><a href="#implementors">Implementors</a></h3></section><div id="rustdoc-modnav"><h2 class="in-crate"><a href="index.html">In crate cnidarium_<wbr>component</a></h2></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><span class="rustdoc-breadcrumbs"><a href="index.html">cnidarium_component</a></span><h1>Trait <span class="trait">ActionHandler</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../src/cnidarium_component/action_handler.rs.html#30-100">source</a> </span></div><pre class="rust item-decl"><code>pub trait ActionHandler {
    type <a href="#associatedtype.CheckStatelessContext" class="associatedtype">CheckStatelessContext</a>: <a class="trait" href="https://doc.rust-lang.org/nightly/core/clone/trait.Clone.html" title="trait core::clone::Clone">Clone</a> + <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'static;

    // Required methods
    fn <a href="#tymethod.check_stateless" class="fn">check_stateless</a>&lt;'life0, 'async_trait&gt;(
        &amp;'life0 self,
        context: Self::<a class="associatedtype" href="trait.ActionHandler.html#associatedtype.CheckStatelessContext" title="type cnidarium_component::ActionHandler::CheckStatelessContext">CheckStatelessContext</a>,
    ) -&gt; <a class="struct" href="https://doc.rust-lang.org/nightly/core/pin/struct.Pin.html" title="struct core::pin::Pin">Pin</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/boxed/struct.Box.html" title="struct alloc::boxed::Box">Box</a>&lt;dyn <a class="trait" href="https://doc.rust-lang.org/nightly/core/future/future/trait.Future.html" title="trait core::future::future::Future">Future</a>&lt;Output = <a class="type" href="../anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;&gt; + <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + 'async_trait&gt;&gt;
       <span class="where">where Self: 'async_trait,
             'life0: 'async_trait</span>;
<span class="item-spacer"></span>    fn <a href="#tymethod.check_and_execute" class="fn">check_and_execute</a>&lt;'life0, 'async_trait, S&gt;(
        &amp;'life0 self,
        state: S,
    ) -&gt; <a class="struct" href="https://doc.rust-lang.org/nightly/core/pin/struct.Pin.html" title="struct core::pin::Pin">Pin</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/boxed/struct.Box.html" title="struct alloc::boxed::Box">Box</a>&lt;dyn <a class="trait" href="https://doc.rust-lang.org/nightly/core/future/future/trait.Future.html" title="trait core::future::future::Future">Future</a>&lt;Output = <a class="type" href="../anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;&gt; + <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + 'async_trait&gt;&gt;
       <span class="where">where S: 'async_trait + <a class="trait" href="../cnidarium/write/trait.StateWrite.html" title="trait cnidarium::write::StateWrite">StateWrite</a>,
             Self: 'async_trait,
             'life0: 'async_trait</span>;

    // Provided method
    fn <a href="#method.check_historical" class="fn">check_historical</a>&lt;'life0, 'async_trait, S&gt;(
        &amp;'life0 self,
        _state: <a class="struct" href="https://doc.rust-lang.org/nightly/alloc/sync/struct.Arc.html" title="struct alloc::sync::Arc">Arc</a>&lt;S&gt;,
    ) -&gt; <a class="struct" href="https://doc.rust-lang.org/nightly/core/pin/struct.Pin.html" title="struct core::pin::Pin">Pin</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/boxed/struct.Box.html" title="struct alloc::boxed::Box">Box</a>&lt;dyn <a class="trait" href="https://doc.rust-lang.org/nightly/core/future/future/trait.Future.html" title="trait core::future::future::Future">Future</a>&lt;Output = <a class="type" href="../anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;&gt; + <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + 'async_trait&gt;&gt;
       <span class="where">where S: 'async_trait + <a class="trait" href="../cnidarium/read/trait.StateRead.html" title="trait cnidarium::read::StateRead">StateRead</a> + 'static,
             Self: <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'async_trait,
             'life0: 'async_trait</span> { ... }
}</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Defines the interface for handling transaction actions.</p>
<p>Block-wide execution is performed using the <a href="trait.Component.html" title="trait cnidarium_component::Component"><code>Component</code></a>
trait.  Per-transaction execution is performed using the <code>ActionHandler</code>
trait.</p>
<p>The <code>ActionHandler</code> trait has a top-level implementation on [<code>Transaction</code>],
which performs any transaction-wide checks and then calls the
<code>ActionHandler</code> implementation for each <a href="penumbra_sdk_transaction::Action"><code>Action</code></a>.</p>
<p>The validation logic in the <code>ActionHandler</code> trait is split into three phases:</p>
<ul>
<li><a href="trait.ActionHandler.html#tymethod.check_stateless" title="method cnidarium_component::ActionHandler::check_stateless"><code>ActionHandler::check_stateless</code></a>, which has no access to chain state, only to the [<code>CheckStatelessContext</code>];</li>
<li>[<code>ActionHandler::check_stateful</code>], which has read access to a snapshot of state prior to transaction execution;</li>
<li>[<code>ActionHandler::execute</code>], which has write access to the state and read access to its own writes.</li>
</ul>
<p>All of these methods are asynchronous and fallible; an error at any level
fails the transaction and aborts any in-progress execution.</p>
<p>These methods are described in more detail below, but in general, as much
work as possible should be pushed up the stack, where greater parallelism is
available, with checks performed in <code>execute</code> only as a last resort.</p>
</div></details><h2 id="required-associated-types" class="section-header">Required Associated Types<a href="#required-associated-types" class="anchor">§</a></h2><div class="methods"><details class="toggle" open><summary><section id="associatedtype.CheckStatelessContext" class="method"><a class="src rightside" href="../src/cnidarium_component/action_handler.rs.html#32">source</a><h4 class="code-header">type <a href="#associatedtype.CheckStatelessContext" class="associatedtype">CheckStatelessContext</a>: <a class="trait" href="https://doc.rust-lang.org/nightly/core/clone/trait.Clone.html" title="trait core::clone::Clone">Clone</a> + <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'static</h4></section></summary><div class="docblock"><p>Context for stateless validity checks, like the transaction containing the action.</p>
</div></details></div><h2 id="required-methods" class="section-header">Required Methods<a href="#required-methods" class="anchor">§</a></h2><div class="methods"><details class="toggle method-toggle" open><summary><section id="tymethod.check_stateless" class="method"><a class="src rightside" href="../src/cnidarium_component/action_handler.rs.html#45">source</a><h4 class="code-header">fn <a href="#tymethod.check_stateless" class="fn">check_stateless</a>&lt;'life0, 'async_trait&gt;(
    &amp;'life0 self,
    context: Self::<a class="associatedtype" href="trait.ActionHandler.html#associatedtype.CheckStatelessContext" title="type cnidarium_component::ActionHandler::CheckStatelessContext">CheckStatelessContext</a>,
) -&gt; <a class="struct" href="https://doc.rust-lang.org/nightly/core/pin/struct.Pin.html" title="struct core::pin::Pin">Pin</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/boxed/struct.Box.html" title="struct alloc::boxed::Box">Box</a>&lt;dyn <a class="trait" href="https://doc.rust-lang.org/nightly/core/future/future/trait.Future.html" title="trait core::future::future::Future">Future</a>&lt;Output = <a class="type" href="../anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;&gt; + <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + 'async_trait&gt;&gt;<div class="where">where
    Self: 'async_trait,
    'life0: 'async_trait,</div></h4></section></summary><div class="docblock"><p>Performs all of this action’s stateless validity checks in the
<code>context</code> of some [<code>Transaction</code>].</p>
<p>This method is <code>async</code> to make it easy to perform stateless validity
checks in parallel, by allowing <code>ActionHandler</code> implementations to
easily spawn tasks internally.</p>
<p>Supplying the <code>context</code> means that stateless checks can use
transaction-wide data like the SCT anchor.</p>
<p>As much work as possible should be done in <code>check_stateless</code>, as it can
be run in parallel across all transactions in a block.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="tymethod.check_and_execute" class="method"><a class="src rightside" href="../src/cnidarium_component/action_handler.rs.html#99">source</a><h4 class="code-header">fn <a href="#tymethod.check_and_execute" class="fn">check_and_execute</a>&lt;'life0, 'async_trait, S&gt;(
    &amp;'life0 self,
    state: S,
) -&gt; <a class="struct" href="https://doc.rust-lang.org/nightly/core/pin/struct.Pin.html" title="struct core::pin::Pin">Pin</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/boxed/struct.Box.html" title="struct alloc::boxed::Box">Box</a>&lt;dyn <a class="trait" href="https://doc.rust-lang.org/nightly/core/future/future/trait.Future.html" title="trait core::future::future::Future">Future</a>&lt;Output = <a class="type" href="../anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;&gt; + <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + 'async_trait&gt;&gt;<div class="where">where
    S: 'async_trait + <a class="trait" href="../cnidarium/write/trait.StateWrite.html" title="trait cnidarium::write::StateWrite">StateWrite</a>,
    Self: 'async_trait,
    'life0: 'async_trait,</div></h4></section></summary><div class="docblock"><p>Attempts to execute this action against the provided <code>state</code>.</p>
<p>This method provides read and write access to the <code>state</code>. It is
fallible, so it’s possible to perform checks within the <code>check_and_execute</code>
implementation and abort execution on error; the [<code>StateTransaction</code>]
mechanism ensures that all writes are correctly discarded.</p>
<p>Because <code>execute</code> must run sequentially, whenever possible, checks
should be performed in <a href="trait.ActionHandler.html#tymethod.check_stateless" title="method cnidarium_component::ActionHandler::check_stateless"><code>ActionHandler::check_stateless</code></a>, or (more carefully) in
<a href="trait.ActionHandler.html#method.check_historical" title="method cnidarium_component::ActionHandler::check_historical"><code>ActionHandler::check_historical</code></a>.  One example of where this is not
possible (in fact, the motivating example) is for IBC, where a
transaction may (1) submit a client update and then (2) relay messages
valid relative to the newly updated state.  In this case, the checks for
(2) must be performed during execution, as they depend on the state
changes written while processing the client update.</p>
<p>However, this data flow pattern should be avoided whenever possible.</p>
<h5 id="invariants"><a class="doc-anchor" href="#invariants">§</a>Invariants</h5>
<p>This method should only be called after an invocation of
<a href="trait.ActionHandler.html#method.check_historical" title="method cnidarium_component::ActionHandler::check_historical"><code>ActionHandler::check_historical</code></a> on the same transaction.  This method
can be called before <a href="trait.Component.html#tymethod.begin_block" title="associated function cnidarium_component::Component::begin_block"><code>Component::begin_block</code></a>.</p>
</div></details></div><h2 id="provided-methods" class="section-header">Provided Methods<a href="#provided-methods" class="anchor">§</a></h2><div class="methods"><details class="toggle method-toggle" open><summary><section id="method.check_historical" class="method"><a class="src rightside" href="../src/cnidarium_component/action_handler.rs.html#71-74">source</a><h4 class="code-header">fn <a href="#method.check_historical" class="fn">check_historical</a>&lt;'life0, 'async_trait, S&gt;(
    &amp;'life0 self,
    _state: <a class="struct" href="https://doc.rust-lang.org/nightly/alloc/sync/struct.Arc.html" title="struct alloc::sync::Arc">Arc</a>&lt;S&gt;,
) -&gt; <a class="struct" href="https://doc.rust-lang.org/nightly/core/pin/struct.Pin.html" title="struct core::pin::Pin">Pin</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/boxed/struct.Box.html" title="struct alloc::boxed::Box">Box</a>&lt;dyn <a class="trait" href="https://doc.rust-lang.org/nightly/core/future/future/trait.Future.html" title="trait core::future::future::Future">Future</a>&lt;Output = <a class="type" href="../anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;&gt; + <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + 'async_trait&gt;&gt;<div class="where">where
    S: 'async_trait + <a class="trait" href="../cnidarium/read/trait.StateRead.html" title="trait cnidarium::read::StateRead">StateRead</a> + 'static,
    Self: <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'async_trait,
    'life0: 'async_trait,</div></h4></section></summary><div class="docblock"><p>Performs those stateful validity checks that can be performed against a
historical state snapshot.</p>
<p>This method provides read access to a snapshot of the <code>State</code> prior to
transaction execution.  It is intended to be run in parallel across all
actions within a transaction.</p>
<h5 id="warning"><a class="doc-anchor" href="#warning">§</a>Warning</h5>
<p>Misuse of this method creates TOCTOU vulnerabilities. Checks performed
in this method must be valid if they are performed against a <em>prior</em>
state, as another action in the same transaction may execute first and
change the state.</p>
<p>Checks performed in this phase should have a justification for why they
are safe to run in parallel with other actions in the same transaction,
and the default behavior should be to perform checks in
<a href="trait.ActionHandler.html#tymethod.check_and_execute" title="method cnidarium_component::ActionHandler::check_and_execute"><code>ActionHandler::check_and_execute</code></a>.</p>
<h5 id="invariants-1"><a class="doc-anchor" href="#invariants-1">§</a>Invariants</h5>
<p>This method should only be called on data that has been checked
with <a href="trait.ActionHandler.html#tymethod.check_stateless" title="method cnidarium_component::ActionHandler::check_stateless"><code>ActionHandler::check_stateless</code></a>.  This method can be called
before <a href="trait.Component.html#tymethod.begin_block" title="associated function cnidarium_component::Component::begin_block"><code>Component::begin_block</code></a>.</p>
</div></details></div><h2 id="object-safety" class="section-header">Object Safety<a href="#object-safety" class="anchor">§</a></h2><div class="object-safety-info">This trait is <b>not</b> <a href="https://doc.rust-lang.org/nightly/reference/items/traits.html#object-safety">object safe</a>.</div><h2 id="implementors" class="section-header">Implementors<a href="#implementors" class="anchor">§</a></h2><div id="implementors-list"></div><script src="../trait.impl/cnidarium_component/action_handler/trait.ActionHandler.js" async></script></section></div></main></body></html>